generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  name          String
  phone         String?
  userType      String    // "customer" or "dealer"
  createdAt     DateTime  @default(now())

  // Password reset fields
  resetToken       String?
  resetTokenExpiry DateTime?

  // Dealer verification status
  verificationStatus String?  @default("pending") // pending, approved, rejected (for dealers)
  verificationNote   String?  // Admin note for rejection reason

  // Dealer specific fields
  businessName        String?
  websiteUrl          String?   // Dealer's website URL for SEO backlinks
  showCustomMessage   Boolean   @default(false)  // Toggle for custom availability message
  availabilityMessage String?   // Custom message shown to customers after availability request
  address             String?
  city          String?
  state         String?
  zip           String?
  workHoursStart String?  // e.g., "09:00"
  workHoursEnd   String?  // e.g., "18:00"
  workDays       String?  // JSON array of days, e.g., ["Monday", "Tuesday", ...]

  // Inventory sync fields (for dealers)
  inventoryFeedUrl   String?   // URL to scrape inventory from (e.g., dealer website)
  inventoryFeedType  String?   // "dealeron", "dealer_com", "xml_feed", "custom"
  autoSyncEnabled    Boolean   @default(false)
  syncFrequencyDays  Int       @default(2)  // How often to sync (default every 2 days)
  lastSyncAt         DateTime?
  lastSyncStatus     String?   // "success", "failed", "in_progress"
  lastSyncMessage    String?   // Error message or summary

  // Relations
  cars          Car[]
  dealLists     DealList[]
  negotiations  Negotiation[]
  acceptedDeals AcceptedDeal[]
  customerTestDrives TestDrive[] @relation("CustomerTestDrives")
  dealerTestDrives   TestDrive[] @relation("DealerTestDrives")
}

model Car {
  id              String   @id @default(uuid())
  dealerId        String
  make            String
  model           String
  year            Int
  vin             String   @unique
  mileage         Int
  color           String
  transmission    String
  salePrice       Float    // Dealer sets, hidden from customers
  description     String
  photos          String   // JSON array of photo URLs
  latitude        Float
  longitude       Float
  city            String
  state           String
  status          String   @default("active") // active, sold, pending
  statusChangedAt DateTime?  // Track when status changed (for auto-sold after 3 days)
  listingFeePaid  Boolean  @default(false)
  createdAt       DateTime @default(now())

  // SEO fields
  slug            String?  @unique  // SEO-friendly URL: "2022-toyota-camry-atlanta-ga"
  bodyType        String?  // SUV, Sedan, Truck, Coupe, etc.
  trim            String?  // LE, XLE, Limited, etc.
  drivetrain      String?  // AWD, FWD, RWD, 4WD
  fuelType        String?  // Gasoline, Diesel, Hybrid, Electric
  engine          String?  // "2.5L 4-Cylinder", "3.5L V6"

  dealer          User     @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  selectedCars    SelectedCar[]
  acceptedDeals   AcceptedDeal[]

  @@index([slug])
}

model DealList {
  id          String   @id @default(uuid())
  customerId  String
  status      String   @default("active") // active, accepted, cancelled
  createdAt   DateTime @default(now())

  customer    User     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  selectedCars SelectedCar[]
}

model SelectedCar {
  id                 String   @id @default(uuid())
  dealListId         String
  carId              String
  originalPrice      Float
  currentOfferPrice  Float
  negotiationCount   Int      @default(0)
  status             String   @default("pending") // pending, won, lost
  createdAt          DateTime @default(now())

  dealList      DealList     @relation(fields: [dealListId], references: [id], onDelete: Cascade)
  car           Car          @relation(fields: [carId], references: [id], onDelete: Cascade)
  negotiations  Negotiation[]
}

model Negotiation {
  id             String   @id @default(uuid())
  selectedCarId  String
  dealerId       String
  offeredPrice   Float
  status         String   @default("pending") // pending, accepted, declined
  createdAt      DateTime @default(now())

  selectedCar SelectedCar @relation(fields: [selectedCarId], references: [id], onDelete: Cascade)
  dealer      User        @relation(fields: [dealerId], references: [id], onDelete: Cascade)
}

model AcceptedDeal {
  id                 String   @id @default(uuid())
  customerId         String
  carId              String
  finalPrice         Float
  verificationCode   String   // 6-digit code
  depositReleased    Boolean  @default(false)
  customerShowedUp   Boolean  @default(false)
  sold               Boolean  @default(false) // Manually marked as sold by dealer
  deadDeal           Boolean  @default(false) // Deal marked as dead/cancelled by dealer
  cancelledByCustomer Boolean @default(false) // Deal cancelled by customer
  createdAt          DateTime @default(now())

  customer User @relation(fields: [customerId], references: [id], onDelete: Cascade)
  car      Car  @relation(fields: [carId], references: [id], onDelete: Cascade)
  testDrive TestDrive?
}

model TestDrive {
  id                 String   @id @default(uuid())
  customerId         String
  dealerId           String
  acceptedDealId     String   @unique
  scheduledDate      String   // Date in YYYY-MM-DD format
  scheduledTime      String   // Time in HH:MM format
  status             String   @default("scheduled") // scheduled, completed, cancelled
  customerNotes      String?
  createdAt          DateTime @default(now())

  customer User @relation("CustomerTestDrives", fields: [customerId], references: [id], onDelete: Cascade)
  dealer   User @relation("DealerTestDrives", fields: [dealerId], references: [id], onDelete: Cascade)
  acceptedDeal AcceptedDeal @relation(fields: [acceptedDealId], references: [id], onDelete: Cascade)
}

model AvailabilityRequest {
  id          String   @id @default(uuid())
  carId       String
  dealerId    String
  firstName   String
  lastName    String
  email       String
  phone       String
  zipCode     String
  comments    String?
  userId      String?  // Optional - if user is logged in
  status      String   @default("pending") // pending, contacted, closed
  createdAt   DateTime @default(now())

  @@index([carId])
  @@index([dealerId])
  @@index([email])
}
